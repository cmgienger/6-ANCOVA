---
title: "Chapter 6 Analysis of Covariance (ANCOVA)"
author: "BIOL 5000"
output:
  html_document:
    df_print: paged
  html_notebook:
    df_print: paged
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.path='Figs/', echo=FALSE, warning=FALSE, message=FALSE)
library(HH) #makes ancovaplots
library(dplyr)
library(ggplot2)
library(ggfortify)
library(emmeans)
```

```{r}
#import and view data
limp <- read.csv("limpet.csv")
limp$SEASON <- as.factor(limp$SEASON) #convert SEASON from character to factor
View(limp)
```

```{r glimpse the data}
glimpse(limp)
```

```{r visualize using ggplot}
#as always, we make a plot to visualize data
plot_eggs <- ggplot(limp, aes(x = DENSITY, y = EGGS, colour = SEASON)) +
  geom_point() +
  scale_color_manual(values = c(spring="green", summer="red")) +
  theme_bw()
plot_eggs
```

Can also use the 'ancovaplot' function in the HH package to plot and fit lines
```{r ancova plot additive}
ancovaplot(EGGS ~ DENSITY + SEASON, data=limp, superpose.panel = TRUE) #equal slopes plot
```

```{r ancova plot interaction}
ancovaplot(EGGS ~ DENSITY * SEASON, data=limp) #separate slopes plot
```

```{r specify model that includes interaction}
#specify the ANCOVA model
limp.mod <- lm(EGGS ~ DENSITY * SEASON, data = limp)

#specify the best-fitting lines, which are model predictions
predictions_limp.mod <- predict(limp.mod)

#details about the model
names(limp.mod)
```
```{r plot with equal slopes}
#plot the predicted values (fitted lines)
plot_eggs + 
  geom_line(aes(y=predictions_limp.mod))
```

```{r check model assumptions, message=FALSE, warning=FALSE}
#check model assumptions
autoplot(limp.mod, smooth.colour = NA)
```

```{r interpret the model}
#interpret the model
anova(limp.mod)
summary(limp.mod)
```

```{r specify model without interaction}
#fit model WITHOUT interaction (since we remove N.S. interaction terms)
limp.mod.nointeraction <- lm(EGGS ~ DENSITY + SEASON, data = limp)
anova(limp.mod.nointeraction)
summary(limp.mod.nointeraction)
```
Doesn't change much because slope and seasons were already significant; we are just re-assigning the '0.0118' variation from interaction back to the other model terms.

```{r compare models}
#compare the two models
anova(limp.mod, limp.mod.nointeraction)
```
P=0.79, so the two models do not have statistically different explanatory power. Likely because there really wasn't much difference in fit lines of the same slopes model vs. the separate slopes model. 

**Add emmeans for comparison**
```{r emmeans}
#these are the mean number of eggs calculated at the average of density
emm_limp.mod.nointeraction <- emmeans(limp.mod.nointeraction, "SEASON")
emm_limp.mod.nointeraction
```
```{r}
means <- limp %>%
  group_by(SEASON) %>%
  summarise(mean=mean(EGGS))
means
#raw means are identical to emmeans due to us forcing a common slope
#by using a model with no interaction.
```
If we adjusted all the points to the grand mean of density, these would be the means. Difference is 0.736 (see summary table for the no interaction model).


